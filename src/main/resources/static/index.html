<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="./reset.css" rel="stylesheet" />
  <link href="./global.css" rel="stylesheet" />
  <link href="./main.css" rel="stylesheet" />
</head>
<body>
<div class="container">
  <header class="header">
    <a href="/"><img src="./img/signiture.svg" /></a>
    <ul class="header_menu">
      <li class="header__menu__item">
        <a class="btn btn_contained btn_size_s" href="/user/list">회원 목록</a>
      </li>
    </ul>
    <ul class="header__menu" id="header-menu">
      <!-- 동적으로 버튼을 생성할 영역 -->
    </ul>
  </header>
  <div class="wrapper">
    <div class="posts" id="posts">
      <!-- 동적으로 게시글을 생성할 영역 -->
    </div>
    <nav class="nav">
      <ul class="nav__menu">
        <li class="header__menu__item">
          <a class="btn btn_contained btn_size_s" href="/write">글작성</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const cookies = document.cookie.split("; ").reduce((acc, cookie) => {
      const [name, value] = cookie.split("=");
      acc[name] = value;
      return acc;
    }, {});

    const headerMenu = document.getElementById("header-menu");

    if (cookies.SID) {
      console.log("SID cookie found, fetching user info...");
      fetch("/user/info", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Cookie": document.cookie
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log("User info fetched:", data);
        const userName = data.username || "사용자";

        headerMenu.innerHTML = `
          <li class="header__menu__item">반갑습니다, ${userName}님</li>
          <li class="header__menu__item">
            <button class="btn btn_contained btn_size_s" id="logout-button">로그아웃</button>
          </li>
        `;
        document.getElementById("logout-button").addEventListener("click", () => {
          document.cookie = "SID=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          location.reload();
        });
      })
      .catch(error => {
        console.error("Error fetching user info:", error);
        showLoginButtons(headerMenu);
      });
    } else {
      showLoginButtons(headerMenu);
    }

    // 게시글 목록을 불러와서 표시
    console.log("Fetching board list...");
    fetch("/board/list", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log("Board list fetched:", data);
      const postsContainer = document.getElementById("posts");

      // 받아온 데이터를 로그로 확인
      console.log("Board data:", data);

      // data가 존재하고 boards 속성이 존재하는지 확인
      if (data && data.boards) {
        // 게시글 목록을 HTML에 추가
        postsContainer.innerHTML = data.boards.map(board => `
          <div class="post">
            <h3 >${board.title}</h3>
          </div>
        `).join("");
      } else {
        console.error("No boards found in the response data.");
        postsContainer.innerHTML = "<p>게시글이 없습니다.</p>";
      }
    })
    .catch(error => console.error("Error fetching boards:", error));

    function showLoginButtons(headerMenu) {
      headerMenu.innerHTML = `
        <li class="header__menu__item">
          <a class="btn btn_contained btn_size_s" href="/login">로그인</a>
        </li>
        <li class="header__menu__item">
          <a class="btn btn_ghost btn_size_s" href="/registration">회원 가입</a>
        </li>
      `;
    }
  });
</script>
</body>
</html>
